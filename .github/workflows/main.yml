name: Update DNS Bebas Sensor

on:
  schedule:
    - cron: '0 3 * * *'   # Pagi jam 10:00 WIB
    - cron: '0 15 * * *'  # Malam jam 22:00 WIB
  workflow_dispatch:

jobs:
  update-dns:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Siapkan folder DNS
      run: mkdir -p dns-upstream

    - name: Generate DNS aktif dari harian-tercepat.txt
      run: |
        > dns-upstream/indonesia-optimal.txt

        while read -r line; do
          server=$(echo "$line" | cut -d'#' -f1 | xargs)
          comment=$(echo "$line" | cut -d'#' -f2- | xargs)
          if [ -z "$server" ] || [[ "$server" =~ ^# ]]; then
            continue
          fi

          timeout 2 dig @${server} google.com +short > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            echo "$server # $comment" >> dns-upstream/indonesia-optimal.txt
          else
            echo "‚ùå DNS $server gagal respons, dilewati"
          fi
        done < dns-upstream/harian-tercepat.txt

    - name: Commit jika ada perubahan
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add dns-upstream/indonesia-optimal.txt
        git commit -m "Auto update DNS aktif dan bebas sensor" || echo "Tidak ada perubahan"
        git push

    - name: Kirim notifikasi Telegram
      run: |
        DNS_CONTENT=$(cat dns-upstream/indonesia-optimal.txt | sed ':a;N;$!ba;s/\n/%0A/g')
        DNS_COUNT=$(grep -vc '^#' dns-upstream/indonesia-optimal.txt)
        TRIGGERED_BY="${{ github.actor }}"
        DATE=$(date +'%Y-%m-%d %H:%M')

        MESSAGE="üì¢ *DNS BEBAS SENSOR DIPERBARUI*%0A%0AüìÖ *Tanggal:* $DATE%0Aüë§ *Pemicu:* $TRIGGERED_BY%0Aüî¢ *Jumlah DNS aktif:* $DNS_COUNT%0Aüõ°Ô∏è *Saring konten dewasa:* ‚ùå Tidak%0A%0A*Isi File:*%0A\`\`\`%0A$DNS_CONTENT%0A\`\`\`"

        curl -s -X POST https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.CHAT_ID }} \
          -d text="$MESSAGE" \
          -d parse_mode=Markdown

    - name: Tes & urutkan DNS aktif berdasarkan latency
      run: |
        mkdir -p dns-upstream
        > dns-upstream/indonesia-optimal.txt
        > dns-upstream/dns-latency-temp.txt

        while read -r line; do
          server=$(echo "$line" | cut -d'#' -f1 | xargs)
          comment=$(echo "$line" | cut -d'#' -f2- | xargs)

          if [ -z "$server" ] || [[ "$server" =~ ^# ]]; then
            continue
          fi

          # Tes latency DNS via dig (timeout 2 detik)
          result=$(dig @$server google.com +stats +timeout=2 2>/dev/null)
          status=$?

          if [ $status -eq 0 ]; then
            latency=$(echo "$result" | grep "Query time" | awk '{print $4}')
            if [ -z "$latency" ]; then latency=9999; fi
            echo "$latency|$server|$comment" >> dns-upstream/dns-latency-temp.txt
          else
            echo "‚ùå DNS $server gagal, dilewati"
          fi
        done < dns-upstream/harian-tercepat.txt

        # Urutkan DNS berdasarkan latency terkecil
        sort -n dns-upstream/dns-latency-temp.txt | while IFS='|' read -r latency server comment; do
          echo "$server # $comment (‚è± $latency ms)" >> dns-upstream/indonesia-optimal.txt
        done





